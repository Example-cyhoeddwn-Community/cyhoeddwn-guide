---
layout: default
title: Architecture
parent: CMS deployment
grand_parent: Deploying cyhoeddwn
nav_order: 3
has_children: false
last_modified_date: 2021-07-03 16:38
---

# Architecture

![](/assets/img/deployment/cyhoeddwn_architecture.png)

cyhoeddwn is built around the [Rails](https://rubyonrails.org/) web app framework for Ruby (an object-oriented programming language). A UML diagram for an example cyhoeddwn deployment is provided below. Users and admins interact with cyhoeddwn through a web application, which is accessed through a phone, tablet, or computer. cyhoeddwn sits either behind a dedicated 'Rack-compatible' server (like Puma) or behind some middleware (like Passenger) which will talk to an HTTP server (like Apache or NGINX) on cyhoeddwn's behalf.

The Rails framework is MVC in nature, that is: 'model, view, controller'. A model used in cyhoeddwn, for example, is 'Post'. A post is a piece of content that has been shared. The attributes of a post ('may have a photo attached', 'must be less than 140 characters', 'belongs to a user', 'has one or many reviews' etc.) are defined in a model. A model verifies the attributes of an instance of a post. Posts can be instantiated (constructed as an instance of a Post class, with associated methods) through talking to a PostgreSQL database through Active Record. This Rails plug-in [serialises](https://en.wikipedia.org/wiki/Serialization) instances of Post through the Active Record [object-relational mapper](https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping).

Views are created as needed through Action View. A view is the HTML/CSS/JS that is visible to the user. Elements of the view can be added programmatically through Action View. For example, posts on a user's page are rendered using Action View, by asking for a user's posts from Active Model, and are then rendered by inserting parts of the post from the record into a template.

The controller in Rails is Action Controller. The controller effectively links the model and view together. An HTTP request is provided to some end-point, which triggers a set of actions. For example, following our example, an HTTP GET request to `/users/1` would:

- be checked against `config/routes.rb` to ensure there is an associated route, there is so,
- the `show` method on the `users` controller would be run,
- the `before_action` method `logged_in_user` is run, redirecting if not logged in,
- the instance variables `@user` and `@posts` are generated from the user's record,
- instance variables are passed to the `show.html.erb` template which passes necessary instance variables to other "partial" templates, thereby rendering the user's page.

Rendered pages (the frontend) generated by Rails are passed through middleware back to the web server, where they are delivered back through the internet either to a user's device or a display.

When performing a task that is likely to lock the main app's process thread, Active Job takes over. The Active Job backend (in this case [Resque](https://github.com/resque/resque)) creates a description of a task that is to be run, and stores it in a queue (as an entry in a highly available, performant Redis key-value pair database). When a worker (a process which can run Ruby tasks) is available to run, jobs can be taken from the queue and performed. Jobs are stored in separate queues based on their importance, all highly important jobs will be performed first, then descending based on order of importance.

Due to the ["ephemeral" nature](https://devcenter.heroku.com/articles/active-storage-on-heroku) of storage space provided by some PaaS/IaaS providers, cyhoeddwn must make use of a more permanent storage place for uploaded media. It is incredibly inefficient to store binary "blobs" (like images and formatted documents) in relational databases, so Rails makes use of a plug-in called Active Storage, where files can be stored and manipulated easily. In this case, cyhoeddwn connects to an [AWS S3](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html) or S3-compatible bucket (i.e. [DigitalOcean Spaces](https://www.digitalocean.com/products/spaces/)) to store photos from posts. Entries for photos in the relational database point towards where photos are stored in a bucket.